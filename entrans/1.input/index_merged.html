<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnTrans Input Form - Enhanced with FCAS Integration &amp; Dashboard</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:,">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

    <style>
        /* Enhanced custom styles with restoration support */
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab content animation */
        .tab-pane {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .tab-pane.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Dashboard integration styles */
        .dashboard-badge {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dashboard-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            color: white;
            text-decoration: none;
        }

        .dashboard-badge.disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Form restoration indicator */
        .restoration-badge {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Analysis progress indicator */
        .analysis-progress {
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            padding: 1rem;
            color: white;
            margin: 1rem 0;
            display: none;
        }

        .analysis-progress.show {
            display: block;
        }

        /* Success notification with dashboard link */
        .success-with-dashboard {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        /* Form validation styles */
        .was-validated .form-control:valid {
            border-color: #10b981;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2310b981' d='m2.3 6.73.5-.4 1.4-1.4c.2-.2.5-.2.7 0s.2.5 0 .7l-2 2c-.2.2-.5.2-.7 0l-1-1c-.2-.2-.2-.5 0-.7s.5-.2.7 0l.4.4z'/%3e%3c/svg%3e");
        }

        .was-validated .form-control:invalid {
            border-color: #ef4444;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23ef4444'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4m0-2.4L5.8 7'/%3e%3c/svg%3e");
        }

        /* FCAS indicator styles */
        .fcas-status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .fcas-status.enabled {
            background-color: #d1fae5;
            color: #065f46;
        }

        .fcas-status.disabled {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        /* Revenue display animation */
        .revenue-counter {
            transition: all 0.5s ease;
        }

        .revenue-counter.updating {
            opacity: 0.6;
            transform: scale(0.95);
        }

        /* Load Data specific styles */
        .load-section {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .load-method-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-method-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .load-method-card.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
        }

        .load-method-card .method-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
        }

        .upload-area.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-progress {
            background: #f3f4f6;
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .upload-progress-bar {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.3s ease;
        }

        .monthly-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .month-input-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 1rem;
        }

        .load-validation-result {
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .load-validation-result.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .load-validation-result.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .load-chart-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            height: 300px;
        }
    </style>
<style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .form-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        .form-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .nav-tabs-custom {
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
        }
        .nav-tabs-custom .nav-link {
            border: none;
            color: #718096;
            font-weight: 500;
            padding: 1rem 1.5rem;
            border-radius: 10px 10px 0 0;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }
        .nav-tabs-custom .nav-link:hover {
            background-color: #f8f9fa;
            color: #667eea;
        }
        .nav-tabs-custom .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: white !important;
            border: none;
        }
        .form-control {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        .progress-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .address-section {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            border: 1px solid #bae6fd;
        }
        .subsection-header {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-left: 4px solid #667eea;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0 1rem 0;
            border-radius: 0 8px 8px 0;
        }
        .subsection-header h4 {
            margin: 0;
            color: #2d3748;
            font-size: 1.1rem;
            font-weight: 600;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            margin-top: 1rem;
            background-color: #f0f0f0;
        }

        /* Tariff-specific styles */
        .tariff-section {
            background: linear-gradient(135deg, #fff5e6, #fff0db);
            border: 1px solid #ffd6a5;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        .tou-schedule-grid {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .tou-period-row {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            margin: 0.5rem 0;
        }
        .demand-charge-section {
            background: linear-gradient(135deg, #fef5e7, #fdf2e9);
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .rate-input-group {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        /* FCAS-specific styles */
        .fcas-section {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #7dd3fc;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        .fcas-service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .fcas-service-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
        }
        .fcas-service-card.enabled {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }
        .fcas-auto-config {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .fcas-revenue-estimate {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        /* Load Data specific styles */
        .load-section {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        .load-method-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .load-method-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        .load-method-card.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
        }
        .load-method-card .method-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
        }
        .upload-area.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .upload-progress {
            background: #f3f4f6;
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .upload-progress-bar {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.3s ease;
        }
        .monthly-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .month-input-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 1rem;
        }
        .load-validation-result {
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .load-validation-result.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .load-validation-result.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .load-chart-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            height: 300px;
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style></head>

<body class="bg-light">
    <!-- Enhanced Header with FCAS Status, Dashboard Link, and Restoration Support -->
    <header class="hero-gradient shadow-sm">
        <div class="container py-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="text-white mb-2 fw-bold">
                        <i class="fas fa-solar-panel me-3"></i>
                        EnTrans Input Form
                        
                    </h1>
                    <p class="text-white-50 mb-0 fs-6">
                        
                        Enhanced Interface with ML-Based FCAS Revenue Forecasting
                        
                    </p>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end align-items-center flex-wrap gap-2">
                        

                        <!-- Dashboard Navigation Badge -->
                        <a href="/dashboard/" class="dashboard-badge" id="dashboard-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Results Dashboard</span>
                        </a>

                        <div class="fcas-status enabled" id="header-fcas-status"><i class="fas fa-bolt me-1"></i><span>FCAS Active</span></div>
                        <div class="text-white-50 small">
                            <i class="fas fa-shield-alt me-1"></i>
                            Secure
                        </div>
                        <div class="text-white-50 small">
                            <i class="fas fa-clock me-1"></i>
                            Auto-Save
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Form Restoration Success Alert -->
    

    <!-- SIMPLIFIED Analysis Progress Indicator - NO PERCENTAGES -->
    <div class="container">
        <div class="analysis-progress" id="analysis-progress">
            <div class="d-flex align-items-center">
                <div class="loading-spinner me-3"></div>
                <div class="flex-grow-1">
                    <div class="fw-bold" id="progress-title">Running Analysis...</div>
                    <div class="small opacity-75" id="progress-message">Please wait while we process your configuration</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container my-5">
        <!-- Form Container -->
        <form id="analysis-form" method="POST" action="/run-analysis" class="needs-validation" novalidate="">

            <!-- Dynamic Form Root - Tabs will be injected here -->
            <div id="dynamic-form-root" class="mb-5"><ul class="nav nav-tabs nav-tabs-custom mb-4"><li class="nav-item"><a class="nav-link" href="#project-information" data-tab="project-information"><i class="fas fa-building me-2"></i>Project Information</a></li><li class="nav-item"><a class="nav-link" href="#pv-configuration" data-tab="pv-configuration"><i class="fas fa-solar-panel me-2"></i>PV Configuration</a></li><li class="nav-item"><a class="nav-link" href="#battery-storage" data-tab="battery-storage"><i class="fas fa-battery-three-quarters me-2"></i>Battery Storage</a></li><li class="nav-item"><a class="nav-link" href="#network-configuration" data-tab="network-configuration"><i class="fas fa-plug me-2"></i>Network Configuration</a></li><li class="nav-item"><a class="nav-link active" href="#financial-parameters" data-tab="financial-parameters"><i class="fas fa-dollar-sign me-2"></i>Financial Parameters</a></li><li class="nav-item"><a class="nav-link" href="#project-costs" data-tab="project-costs"><i class="fas fa-calculator me-2"></i>Project Costs</a></li><li class="nav-item"><a class="nav-link" href="#load" data-tab="load"><i class="fas fa-chart-line me-2"></i>Load</a></li></ul><div class="tab-content"><div class="tab-pane fade" id="project-information"><div class="form-card p-4"><h3 class="mb-4"><i class="fas fa-building me-2 text-primary"></i>Project Information</h3>
        <div class="address-section">
            <div class="subsection-header">
                <h4><i class="fas fa-map-marker-alt me-2"></i>Project Location</h4>
            </div>
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="project-address" class="form-label">Project Address</label>
                    <input type="text" class="form-control" id="project-address" placeholder="Enter full project address" value="4444">
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-primary w-100" id="geocode-btn"><i class="fas fa-search-location me-2"></i>Locate</button>
                </div>
                <div class="col-12">
                    <div id="map" class="leaflet-container leaflet-touch leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" style="position: relative;" tabindex="0"><div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(0px, 0px, 0px);"><div class="leaflet-pane leaflet-tile-pane"><div class="leaflet-layer " style="z-index: 1; opacity: 1;"><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 18; transform: translate3d(0px, 0px, 0px) scale(1);"><img alt="" src="https://c.tile.openstreetmap.org/13/7487/4953.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(429px, -118px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/13/7487/4954.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(429px, 138px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/13/7486/4953.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(173px, -118px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/13/7488/4953.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(685px, -118px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/13/7486/4954.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(173px, 138px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/13/7488/4954.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(685px, 138px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/13/7485/4953.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-83px, -118px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/13/7489/4953.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(941px, -118px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/13/7485/4954.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-83px, 138px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/13/7489/4954.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(941px, 138px, 0px); opacity: 1;"></div></div></div><div class="leaflet-pane leaflet-overlay-pane"></div><div class="leaflet-pane leaflet-shadow-pane"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(597px, 148px, 0px);" alt=""></div><div class="leaflet-pane leaflet-marker-pane"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(597px, 148px, 0px); z-index: 148;" alt="Marker" tabindex="0" role="button"></div><div class="leaflet-pane leaflet-tooltip-pane"></div><div class="leaflet-pane leaflet-popup-pane"></div><div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(1916840px, 1268230px, 0px) scale(4096);"></div></div><div class="leaflet-control-container"><div class="leaflet-top leaflet-left"><div class="leaflet-control-zoom leaflet-bar leaflet-control"><a class="leaflet-control-zoom-in" href="#" title="Zoom in" role="button" aria-label="Zoom in" aria-disabled="false"><span aria-hidden="true">+</span></a><a class="leaflet-control-zoom-out" href="#" title="Zoom out" role="button" aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">‚àí</span></a></div></div><div class="leaflet-top leaflet-right"></div><div class="leaflet-bottom leaflet-left"></div><div class="leaflet-bottom leaflet-right"><div class="leaflet-control-attribution leaflet-control"><a href="https://leafletjs.com" title="A JavaScript library for interactive maps"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag"><path fill="#4C7BE1" d="M0 0h12v4H0z"></path><path fill="#FFD500" d="M0 4h12v3H0z"></path><path fill="#E0BC00" d="M0 7h12v1H0z"></path></svg> Leaflet</a> <span aria-hidden="true">|</span> ¬© OpenStreetMap contributors</div></div></div></div>
                </div>
                <div class="col-md-6">
                    <label for="latitude" class="form-label">Latitude</label>
                    <input type="number" class="form-control" id="latitude" data-pysam-module="site" data-pysam-key="lat" min="-90" max="90" step="any" required="" value="-35.2469814">
                </div>
                <div class="col-md-6">
                    <label for="longitude" class="form-label">Longitude</label>
                    <input type="number" class="form-control" id="longitude" data-pysam-module="site" data-pysam-key="lon" min="-180" max="180" step="any" required="" value="149.0473672">
                </div>
            </div>
        </div>
    <div class="subsection-header mt-4"><h4><i class="fas fa-info-circle me-2"></i>Project Details</h4></div><div class="row"><div class="col-md-6"><div class="mb-3"><label for="project_owner" class="form-label">Project Owner</label><input type="text" class="form-control" id="project_owner" data-pysam-key="project_owner" value="Consultant 1"><div class="form-text text-muted small">Name of entity considering the project</div></div></div><div class="col-md-6"><div class="mb-3"><label for="project_date_eval" class="form-label">Project Evaluation Date</label><input type="date" class="form-control" id="project_date_eval" data-pysam-key="project_date_eval" value="2025-09-03"><div class="form-text text-muted small">Date of evaluation</div></div></div><div class="col-md-6"><div class="mb-3"><label for="project_id" class="form-label">Project ID</label><input type="text" class="form-control" id="project_id" data-pysam-key="project_id" value="123456B"><div class="form-text text-muted small">Identifying number or reference</div></div></div><div class="col-md-6"><div class="mb-3"><label for="project_desc" class="form-label">Project Description</label><input type="text" class="form-control" id="project_desc" data-pysam-key="project_desc" value="Solar &amp; Battery Project #1"><div class="form-text text-muted small">Brief outline of the project</div></div></div><div class="col-md-6"><div class="mb-3"><label for="analysis_period" class="form-label">Project Lifetime (years)</label><input type="number" class="form-control" id="analysis_period" data-pysam-key="analysis_period" data-pysam-module="Cashloan" min="1" max="50" value="10"><div class="form-text text-muted small">Length of financial analysis period</div></div></div><div class="col-md-6"><div class="mb-3"><label for="tz" class="form-label">Project Timezone</label><select class="form-control" id="tz" data-pysam-key="tz" data-pysam-module="UtilityRate5" value=""><option value="" selected="selected">-- Select --</option><option value="AEST">AEST</option><option value="ACST">ACST</option><option value="AWST">AWST</option></select></div></div><div class="col-md-6"><div class="mb-3"><label for="project_evaluator" class="form-label">Project Evaluator</label><input type="text" class="form-control" id="project_evaluator" data-pysam-key="project_evaluator" value="ETC pty ltd"><div class="form-text text-muted small">Name of Project Evaluator</div></div></div><div class="col-md-6"><div class="mb-3"><label for="project_evaluator_contact" class="form-label">Project Evaluator Contacts</label><input type="text" class="form-control" id="project_evaluator_contact" data-pysam-key="project_evaluator_contact" value="1234567"><div class="form-text text-muted small">Phone and email of Project Evaluator</div></div></div></div></div></div><div class="tab-pane fade" id="pv-configuration"><div class="form-card p-4"><h3 class="mb-4"><i class="fas fa-solar-panel me-2 text-primary"></i>PV Configuration</h3><div class="row"><div class="col-md-6"><div class="mb-3"><label for="system_capacity" class="form-label">New System Size (kW)</label><input type="number" class="form-control" id="system_capacity" data-pysam-key="system_capacity" data-pysam-module="Pvsamv1" min="0" value="300"><div class="form-text text-muted small">Project Solar install</div></div></div><div class="col-md-6"><div class="mb-3"><label for="land_area" class="form-label">Land area (acres)</label><input type="number" class="form-control" id="land_area" data-pysam-key="land_area" data-pysam-module="Pvsamv1" step="0.01" min="0" value=""><div class="form-text text-muted small">Allocated land area</div></div></div><div class="col-md-6"><div class="mb-3"><label for="roof_space" class="form-label">Roof space (m2)</label><input type="number" class="form-control" id="roof_space" data-pysam-key="roof_space" data-pysam-module="Pvsamv1" step="0.01" min="0" value=""><div class="form-text text-muted small">Usable roof space</div></div></div><div class="col-md-6"><div class="mb-3"><label for="subarray1_tilt" class="form-label">Tilt (degrees)</label><input type="number" class="form-control" id="subarray1_tilt" data-pysam-key="subarray1_tilt" data-pysam-module="Pvsamv1" step="0.01" min="0" max="90" value="20"><div class="form-text text-muted small">Tilt angle of PV panels</div></div></div><div class="col-md-6"><div class="mb-3"><label for="subarray1_azimuth" class="form-label">Azimuth (degrees)</label><input type="number" class="form-control" id="subarray1_azimuth" data-pysam-key="subarray1_azimuth" data-pysam-module="Pvsamv1" step="0.01" min="0" max="359" value="0"><div class="form-text text-muted small">Orientation of PV array</div></div></div><div class="col-md-6"><div class="mb-3"><label for="inv_snl_eff_cec" class="form-label">Inverter Efficiency (%)</label><div class="input-group"><input type="number" class="form-control" id="inv_snl_eff_cec" data-pysam-key="inv_snl_eff_cec" data-pysam-module="Pvsamv1" step="0.1" min="0" max="100" value="98.7"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Inverter efficiency</div></div></div><div class="col-md-6"><div class="mb-3"><label for="dc_degradation" class="form-label">Degradation Rate (%)</label><div class="input-group"><input type="number" class="form-control" id="dc_degradation" data-pysam-key="dc_degradation" data-pysam-module="Pvsamv1" step="0.1" min="0" max="100" value="0.5"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Annual degradation rate of PV system</div></div></div><div class="col-md-6"><div class="mb-3"><label for="subarray1_dcwiring_loss" class="form-label">DCWiring Losses (%)</label><div class="input-group"><input type="number" class="form-control" id="subarray1_dcwiring_loss" data-pysam-key="subarray1_dcwiring_loss" data-pysam-module="Pvsamv1" step="0.1" min="0" max="100" value="2"><span class="input-group-text">%</span></div><div class="form-text text-muted small">DCWiring Losses (%)</div></div></div></div></div></div><div class="tab-pane fade" id="battery-storage"><div class="form-card p-4"><h3 class="mb-4"><i class="fas fa-battery-three-quarters me-2 text-primary"></i>Battery Storage</h3><div class="row"><div class="col-md-6"><div class="mb-3"><label for="en_batt" class="form-label">Include storage?</label><select class="form-control" id="en_batt" data-pysam-key="en_batt" data-pysam-module="Pvsamv1" value="yes"><option value="">-- Select --</option><option value="yes" selected="selected">yes</option><option value="no">no</option></select></div></div><div class="col-md-6"><div class="mb-3"><label for="batt_computed_bank_capacity" class="form-label">Battery Energy Capacity (kWh)</label><input type="number" class="form-control" id="batt_computed_bank_capacity" data-pysam-key="batt_computed_bank_capacity" data-pysam-module="Pvsamv1" step="0.01" min="0" value="1200"><div class="form-text text-muted small">Energy capacity of battery</div></div></div><div class="col-md-6"><div class="mb-3"><label for="batt_power_charge_max_kwac" class="form-label">Maximum Charge Rate (C-rate)</label><input type="number" class="form-control" id="batt_power_charge_max_kwac" data-pysam-key="batt_power_charge_max_kwac" data-pysam-module="Pvsamv1" step="0.01" min="0" value="300"><div class="form-text text-muted small">Max charge rate relative to capacity</div></div></div><div class="col-md-6"><div class="mb-3"><label for="batt_power_discharge_max_kwac" class="form-label">Maximum Discharge Rate (C-rate)</label><input type="number" class="form-control" id="batt_power_discharge_max_kwac" data-pysam-key="batt_power_discharge_max_kwac" data-pysam-module="Pvsamv1" step="0.01" min="0" value="300"><div class="form-text text-muted small">Max discharge rate relative to capacity</div></div></div><div class="col-md-6"><div class="mb-3"><label for="batt_ac_dc_efficiency" class="form-label">Battery Roundtrip Efficiency (%)</label><div class="input-group"><input type="number" class="form-control" id="batt_ac_dc_efficiency" data-pysam-key="batt_ac_dc_efficiency" data-pysam-module="Pvsamv1" step="0.1" min="0" max="100" value="96"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Battery roundtrip efficiency</div></div></div><div class="col-md-6"><div class="mb-3"><label for="batt_minimum_SOC" class="form-label">Battery Depth of Discharge min (%)</label><div class="input-group"><input type="number" class="form-control" id="batt_minimum_SOC" data-pysam-key="batt_minimum_SOC" data-pysam-module="Pvsamv1" step="0.1" min="0" max="100" value="30"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Usable depth of discharge (max/min SOC limits)</div></div></div><div class="col-md-6"><div class="mb-3"><label for="batt_maximum_SOC" class="form-label">Battery Depth of Discharge max (%)</label><div class="input-group"><input type="number" class="form-control" id="batt_maximum_SOC" data-pysam-key="batt_maximum_SOC" data-pysam-module="Pvsamv1" step="0.1" min="0" max="100" value="95"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Usable depth of discharge (max/min SOC limits)</div></div></div><div class="col-md-6"><div class="mb-3"><label for="batt_calendar_choice" class="form-label">Battery Degradation Model</label><select class="form-control" id="batt_calendar_choice" data-pysam-key="batt_calendar_choice" data-pysam-module="Pvsamv1" value=""><option value="" selected="selected">-- Select --</option><option value="0=No Calendar Degradation">0=No Calendar Degradation</option><option value="1=Lithium Ion Model">1=Lithium Ion Model</option><option value="2=Input Loss Table">2=Input Loss Table</option></select></div></div><div class="col-md-6"><div class="mb-3"><label for="batt_dispatch_choice" class="form-label fw-semibold">Battery Dispatch Strategy</label><select class="form-control" id="batt_dispatch_choice" data-pysam-key="batt_dispatch_choice" data-pysam-module="Pvsamv1" onchange="updateBatteryDispatchDescription(this.value)" value="4"><option value="0">üìä Peak Shaving</option><option value="4" selected="selected">‚ö° Smart Energy Trading (Recommended) (Recommended)</option><option value="5">üè† Self Consumption</option></select>
        <div class="mt-3 p-3 bg-light rounded" id="battery-dispatch-description">
            <div class="d-flex align-items-start">
                <div class="me-3">
                    <span class="fs-4" id="dispatch-icon">‚ö°</span>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1" id="dispatch-name">Smart Energy Trading (Recommended)</h6>
                    <p class="mb-0 text-muted small" id="dispatch-desc">
                        Optimizes time-of-use arbitrage + FCAS revenue automatically
                    </p>
                </div>
            </div>
        </div>
    </div></div></div></div></div><div class="tab-pane fade" id="network-configuration"><div class="form-card p-4"><h3 class="mb-4"><i class="fas fa-plug me-2 text-primary"></i>Network Configuration</h3>
        <div class="tariff-section" id="tariff-config-container">
            <div class="subsection-header">
                <h4><i class="fas fa-plug me-2"></i>Network Tariff Configuration</h4>
            </div>
            <div id="tariff-controls" class="space-y-6">
        <div class="mb-4">
            <label for="tariff-type-select" class="form-label fw-semibold">Tariff Type</label>
            <select id="tariff-type-select" class="form-control" value="Flat">
                <option value="Flat" selected="selected">Flat Rate</option>
                <option value="TOU">Time-of-Use (TOU)</option>
            </select>
        </div>
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <label for="monthly-fixed-charge" class="form-label fw-semibold">
                Monthly Fixed Charge ($)
            </label>
            <input type="number" id="monthly-fixed-charge" value="10.00" step="0.01" min="0" class="form-control">
        </div>
        <div class="col-md-6">
            <label for="feed-in-tariff" class="form-label fw-semibold">
                Feed-in Tariff ($/kWh)
            </label>
            <input type="number" id="feed-in-tariff" value="0.05" step="0.0001" min="0" class="form-control">
        </div>
    </div></div>
            <div id="tariff-config-details" class="space-y-6">
        <div class="rate-input-group">
            <h5 class="mb-3"><i class="fas fa-dollar-sign me-2"></i>Flat Rate Configuration</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="flat-rate" class="form-label fw-semibold">
                        Energy Rate ($/kWh)
                    </label>
                    <input type="number" id="flat-rate" value="0.12" step="0.0001" min="0" class="form-control">
                </div>
            </div>
        </div>
    </div>
        <input type="hidden" id="monthly_fixed_charge" data-pysam-module="UtilityRate5" data-pysam-key="monthly_fixed_charge" value=""><input type="hidden" id="ur_ec_sched_weekday" data-pysam-module="UtilityRate5" data-pysam-key="ur_ec_sched_weekday" value=""><input type="hidden" id="ur_ec_sched_weekend" data-pysam-module="UtilityRate5" data-pysam-key="ur_ec_sched_weekend" value=""><input type="hidden" id="ur_ec_tou_mat" data-pysam-module="UtilityRate5" data-pysam-key="ur_ec_tou_mat" value=""><input type="hidden" id="ur_dc_flat_mat" data-pysam-module="UtilityRate5" data-pysam-key="ur_dc_flat_mat" value=""><input type="hidden" id="ur_ec_export_mat" data-pysam-module="UtilityRate5" data-pysam-key="ur_ec_export_mat" value=""></div>
    </div></div><div class="tab-pane fade show active" id="financial-parameters"><div class="form-card p-4"><h3 class="mb-4"><i class="fas fa-dollar-sign me-2 text-primary"></i>Financial Parameters</h3><div class="row"><div class="col-md-6"><div class="mb-3"><label for="inflation_rate" class="form-label">Inflation Rate (%)</label><div class="input-group"><input type="number" class="form-control" id="inflation_rate" data-pysam-key="inflation_rate" data-pysam-module="Cashloan" step="0.1" min="0" max="100" value="2.5"><span class="input-group-text">%</span></div><div class="form-text text-muted small">General inflation rate applied to O&amp;M costs</div></div></div><div class="col-md-6"><div class="mb-3"><label for="real_discount_rate" class="form-label">Discount Rate (%) (real)</label><div class="input-group"><input type="number" class="form-control" id="real_discount_rate" data-pysam-key="real_discount_rate" data-pysam-module="Cashloan" step="0.1" min="0" max="100" value="7"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Discount rate for NPV calculations</div></div></div><div class="col-md-6"><div class="mb-3"><label for="federal_tax_rate" class="form-label">Tax Rate %</label><div class="input-group"><input type="number" class="form-control" id="federal_tax_rate" data-pysam-key="federal_tax_rate" data-pysam-module="Cashloan" step="0.1" min="0" max="100" value="25"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Corporate taxation rate</div></div></div><div class="col-md-6"><div class="mb-3"><label for="debt_fraction" class="form-label">Debt Fraction (%)</label><div class="input-group"><input type="number" class="form-control" id="debt_fraction" data-pysam-key="debt_fraction" data-pysam-module="Cashloan" step="0.1" min="0" max="100" value="60"><span class="input-group-text">%</span></div><div class="form-text text-muted small">% of capital financed via debt.</div></div></div><div class="col-md-6"><div class="mb-3"><label for="loan_rate" class="form-label">Loan Interest Rate (%)</label><div class="input-group"><input type="number" class="form-control" id="loan_rate" data-pysam-key="loan_rate" data-pysam-module="Cashloan" step="0.1" min="0" max="100" value="10"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Annual interest rate on debt.</div></div></div><div class="col-md-6"><div class="mb-3"><label for="loan_term" class="form-label">Loan Term (years)</label><input type="number" class="form-control" id="loan_term" data-pysam-key="loan_term" data-pysam-module="Cashloan" min="1" max="40" value="25"><div class="form-text text-muted small">Loan repayment period.</div></div></div><div class="col-md-6"><div class="mb-3"><label for="macrs_option_years" class="form-label">Depreciation Method</label><select class="form-control" id="macrs_option_years" data-pysam-key="macrs_option_years" data-pysam-module="Cashloan" value=""><option value="" selected="selected">-- Select --</option><option value="0=5">0=5</option><option value="1=7">1=7</option><option value="2=15 yrs">2=15 yrs</option></select></div></div><div class="col-md-6"><div class="mb-3"><label for="macrs_bonus_frac" class="form-label">Bonus Depreciation (%)</label><div class="input-group"><input type="number" class="form-control" id="macrs_bonus_frac" data-pysam-key="macrs_bonus_frac" data-pysam-module="Cashloan" step="0.1" min="0" max="100" value=""><span class="input-group-text">%</span></div><div class="form-text text-muted small">% of asset value depreciated Year 1.</div></div></div><div class="col-md-6"><div class="mb-3"><label for="voll" class="form-label">Value of Lost Load $/kWh</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="voll" data-pysam-key="voll" data-pysam-module="Pvsamv1" step="0.01" min="0" value="0.35"></div><div class="form-text text-muted small">value of lost load for resilience calcs</div></div></div><div class="col-md-6"><div class="mb-3"><label for="incentive_stc" class="form-label">STC Price Avg ($)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="incentive_stc" data-pysam-key="incentive_stc" data-pysam-module="Cashloan" step="0.01" min="0" value="40"></div><div class="form-text text-muted small">Small scale renewable certificates</div></div></div><div class="col-md-6"><div class="mb-3"><label for="incentive_lrec" class="form-label">LREC Price Avg ($)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="incentive_lrec" data-pysam-key="incentive_lrec" data-pysam-module="Cashloan" step="0.01" min="0" value="45"></div><div class="form-text text-muted small">Large scale renewable certificates</div></div></div><div class="col-md-6"><div class="mb-3"><label for="mp_energy_market_revenue" class="form-label">Energy arbitrage Y/N?</label><select class="form-control" id="mp_energy_market_revenue" data-pysam-key="mp_energy_market_revenue" data-pysam-module="Pvsamv1" value=""><option value="" selected="selected">-- Select --</option><option value="yes">yes</option><option value="no">no</option></select></div></div></div>
        <div class="fcas-section" id="fcas-config-container">
            <div class="subsection-header">
                <h4><i class="fas fa-bolt me-2"></i>FCAS (Frequency Control Ancillary Services)</h4>
            </div>

            <div class="fcas-auto-config mb-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-1"><i class="fas fa-magic me-2"></i>Enhanced FCAS Revenue Forecasting</h5>
                        <p class="text-muted mb-0 fs-6">ML-based forecasting for Australian NEM FCAS markets</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="fcas-enable" data-pysam-key="fcas_enabled" checked="checked" data-user-configured="true">
                        <label class="form-check-label fw-semibold" for="fcas-enable">
                            Enable FCAS
                        </label>
                    </div>
                </div>
            </div>

            <div id="fcas-configuration" class="space-y-6" style="display: block;">
                <div class="fcas-auto-config">
                    <h5 class="mb-3"><i class="fas fa-cog me-2"></i>Auto-Configuration</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="fcas-region" class="form-label fw-semibold">
                                NEM Region <i class="fas fa-info-circle text-muted" title="Auto-detected from project location"></i>
                            </label>
                            <select id="fcas-region" class="form-control" data-pysam-key="fcas_region" value="NSW1">
                                <option value="NSW1" selected="selected">NSW1 - New South Wales</option>
                                <option value="VIC1">VIC1 - Victoria</option>
                                <option value="QLD1">QLD1 - Queensland</option>
                                <option value="SA1">SA1 - South Australia</option>
                                <option value="TAS1">TAS1 - Tasmania</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="fcas-participation-rate" class="form-label fw-semibold">
                                Participation Rate (%) <i class="fas fa-info-circle text-muted" title="Auto-calculated from battery size"></i>
                            </label>
                            <input type="number" id="fcas-participation-rate" class="form-control" data-pysam-key="fcas_participation_rate" min="0" max="100" step="1" value="85" readonly="">
                        </div>
                        <div class="col-md-4">
                            <label for="fcas-battery-reserve" class="form-label fw-semibold">
                                Battery Reserve (%)
                            </label>
                            <input type="number" id="fcas-battery-reserve" class="form-control" data-pysam-key="fcas_battery_reserve" min="0" max="50" step="5" value="20">
                        </div>
                    </div>
                </div>

                <div class="rate-input-group">
                    <h5 class="mb-3"><i class="fas fa-list-check me-2"></i>FCAS Services Selection</h5>
                    <div class="fcas-service-grid" id="fcas-services-grid">
        <div class="fcas-service-card enabled" data-service="fcas_enable_fast_raise">
            <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-arrow-up me-2 text-primary"></i>
                    <strong>Fast Raise (6s)</strong>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input fcas-service-toggle" type="checkbox" id="fcas_enable_fast_raise" data-pysam-key="fcas_enable_fast_raise" checked="checked">
                </div>
            </div>
            <p class="text-muted small mb-2">Rapid frequency response for under-frequency events</p>
            <span class="badge bg-success">Recommended</span>
        </div>
    
        <div class="fcas-service-card enabled" data-service="fcas_enable_fast_lower">
            <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-arrow-down me-2 text-primary"></i>
                    <strong>Fast Lower (6s)</strong>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input fcas-service-toggle" type="checkbox" id="fcas_enable_fast_lower" data-pysam-key="fcas_enable_fast_lower" checked="checked">
                </div>
            </div>
            <p class="text-muted small mb-2">Rapid frequency response for over-frequency events</p>
            <span class="badge bg-success">Recommended</span>
        </div>
    
        <div class="fcas-service-card enabled" data-service="fcas_enable_slow_raise">
            <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-chevron-up me-2 text-primary"></i>
                    <strong>Slow Raise (60s)</strong>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input fcas-service-toggle" type="checkbox" id="fcas_enable_slow_raise" data-pysam-key="fcas_enable_slow_raise" checked="checked">
                </div>
            </div>
            <p class="text-muted small mb-2">Sustained frequency response for under-frequency events</p>
            <span class="badge bg-success">Recommended</span>
        </div>
    
        <div class="fcas-service-card enabled" data-service="fcas_enable_slow_lower">
            <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-chevron-down me-2 text-primary"></i>
                    <strong>Slow Lower (60s)</strong>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input fcas-service-toggle" type="checkbox" id="fcas_enable_slow_lower" data-pysam-key="fcas_enable_slow_lower" checked="checked">
                </div>
            </div>
            <p class="text-muted small mb-2">Sustained frequency response for over-frequency events</p>
            <span class="badge bg-success">Recommended</span>
        </div>
    
        <div class="fcas-service-card " data-service="fcas_enable_delayed_raise">
            <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock me-2 text-primary"></i>
                    <strong>Delayed Raise (5min)</strong>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input fcas-service-toggle" type="checkbox" id="fcas_enable_delayed_raise" data-pysam-key="fcas_enable_delayed_raise">
                </div>
            </div>
            <p class="text-muted small mb-2">Extended frequency response for under-frequency events</p>
            <span class="badge bg-secondary">Optional</span>
        </div>
    
        <div class="fcas-service-card " data-service="fcas_enable_delayed_lower">
            <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock me-2 text-primary"></i>
                    <strong>Delayed Lower (5min)</strong>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input fcas-service-toggle" type="checkbox" id="fcas_enable_delayed_lower" data-pysam-key="fcas_enable_delayed_lower">
                </div>
            </div>
            <p class="text-muted small mb-2">Extended frequency response for over-frequency events</p>
            <span class="badge bg-secondary">Optional</span>
        </div>
    
        <div class="fcas-service-card " data-service="fcas_enable_raise_regulation">
            <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wave-square me-2 text-primary"></i>
                    <strong>Raise Regulation</strong>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input fcas-service-toggle" type="checkbox" id="fcas_enable_raise_regulation" data-pysam-key="fcas_enable_raise_regulation">
                </div>
            </div>
            <p class="text-muted small mb-2">Continuous regulation for small frequency deviations</p>
            <span class="badge bg-secondary">Optional</span>
        </div>
    
        <div class="fcas-service-card " data-service="fcas_enable_lower_regulation">
            <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wave-square me-2 text-primary"></i>
                    <strong>Lower Regulation</strong>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input fcas-service-toggle" type="checkbox" id="fcas_enable_lower_regulation" data-pysam-key="fcas_enable_lower_regulation">
                </div>
            </div>
            <p class="text-muted small mb-2">Continuous regulation for small frequency deviations</p>
            <span class="badge bg-secondary">Optional</span>
        </div>
    </div>
                </div>

                <div class="fcas-revenue-estimate" id="fcas-revenue-display">
                    <h5 class="mb-2"><i class="fas fa-chart-line me-2"></i>Estimated Annual FCAS Revenue</h5>
                    <div class="fs-2 fw-bold text-success" id="fcas-revenue-amount">13,090</div>
                    <small class="text-muted">Based on current configuration and historical market data</small>
                </div>

                <div class="collapse" id="fcas-advanced-config">
                    <div class="rate-input-group">
                        <h5 class="mb-3"><i class="fas fa-cogs me-2"></i>Advanced Configuration</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="fcas-forecast-method" class="form-label fw-semibold">Forecast Method</label>
                                <select id="fcas-forecast-method" class="form-control" data-pysam-key="fcas_forecast_method" value="ML">
                                    <option value="ML" selected="selected">Machine Learning (Recommended)</option>
                                    <option value="historical">Historical Average</option>
                                    <option value="conservative">Conservative Estimate</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="fcas-database-path" class="form-label fw-semibold">Database Path</label>
                                <input type="text" id="fcas-database-path" class="form-control" data-pysam-key="fcas_db_path" value="FCAS/nem_data_final.db" readonly="">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="fcas-fast-premium" class="form-label fw-semibold">Fast Services Premium ($/MW/5min)</label>
                                <input type="number" id="fcas-fast-premium" class="form-control" data-pysam-key="fcas_fast_premium" min="0" step="0.01" value="0">
                            </div>
                            <div class="col-md-6">
                                <label for="fcas-regulation-premium" class="form-label fw-semibold">Regulation Premium ($/MW/5min)</label>
                                <input type="number" id="fcas-regulation-premium" class="form-control" data-pysam-key="fcas_regulation_premium" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#fcas-advanced-config">
                        <i class="fas fa-chevron-down me-2"></i>Advanced Configuration
                    </button>
                </div>
            </div>
        <input type="hidden" id="hidden_fcas_enabled" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enabled" value="Yes"><input type="hidden" id="hidden_fcas_region" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_region" value="NSW1"><input type="hidden" id="hidden_fcas_participation_rate" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_participation_rate" value="85"><input type="hidden" id="hidden_fcas_db_path" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_db_path" value="FCAS/nem_data_final.db"><input type="hidden" id="hidden_fcas_battery_reserve" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_battery_reserve" value="20"><input type="hidden" id="hidden_fcas_enable_fast_raise" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enable_fast_raise" value="Yes"><input type="hidden" id="hidden_fcas_enable_fast_lower" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enable_fast_lower" value="Yes"><input type="hidden" id="hidden_fcas_enable_slow_raise" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enable_slow_raise" value="Yes"><input type="hidden" id="hidden_fcas_enable_slow_lower" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enable_slow_lower" value="Yes"><input type="hidden" id="hidden_fcas_enable_delayed_raise" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enable_delayed_raise" value="No"><input type="hidden" id="hidden_fcas_enable_delayed_lower" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enable_delayed_lower" value="No"><input type="hidden" id="hidden_fcas_enable_raise_regulation" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enable_raise_regulation" value="No"><input type="hidden" id="hidden_fcas_enable_lower_regulation" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_enable_lower_regulation" value="No"><input type="hidden" id="hidden_fcas_forecast_method" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_forecast_method" value="ML"><input type="hidden" id="hidden_fcas_fast_premium" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_fast_premium" value="0"><input type="hidden" id="hidden_fcas_regulation_premium" data-pysam-module="Enhanced_FCAS" data-pysam-key="fcas_regulation_premium" value="0"></div>
    </div></div><div class="tab-pane fade" id="project-costs"><div class="form-card p-4"><h3 class="mb-4"><i class="fas fa-calculator me-2 text-primary"></i>Project Costs</h3><div class="subsection-header"><h4><i class="fas fa-layer-group me-2"></i>PV ($)</h4></div><div class="row"><div class="col-md-6"><div class="mb-3"><label for="total_installed_cost" class="form-label">Cost per kW ($/kW DC)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="total_installed_cost" data-pysam-key="total_installed_cost" data-pysam-module="Pvsamv1" step="0.01" min="0" value="1000"></div><div class="form-text text-muted small">Total installed cost</div></div></div><div class="col-md-6"><div class="mb-3"><label for="om_capacity" class="form-label">OM Costs per kW ($/kW/year)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="om_capacity" data-pysam-key="om_capacity" data-pysam-module="Pvsamv1" step="0.01" min="0" value="21"></div><div class="form-text text-muted small">Fixed O&amp;M Cost</div></div></div><div class="col-md-6"><div class="mb-3"><label for="om_production" class="form-label">OM Costs per kWh ($/kWh)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="om_production" data-pysam-key="om_production" data-pysam-module="Pvsamv1" step="0.01" min="0" value="1.5"></div><div class="form-text text-muted small">Variable O&amp;M Cost</div></div></div><div class="col-md-6"><div class="mb-3"><label for="bos_pv_cost" class="form-label">Balance of system equipment</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="bos_pv_cost" data-pysam-key="bos_pv_cost" data-pysam-module="Pvsamv1" step="0.01" min="0" value="555"></div><div class="form-text text-muted small">Balance of system (PV) costs</div></div></div><div class="col-md-6"><div class="mb-3"><label for="inverter_cost" class="form-label">Inverter Cost ($/W)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="inverter_cost" data-pysam-key="inverter_cost" data-pysam-module="Pvsamv1" step="0.01" min="0" value="444"></div><div class="form-text text-muted small">Inverter cost installed</div></div></div></div><div class="subsection-header"><h4><i class="fas fa-layer-group me-2"></i>Battery ($)</h4></div><div class="row"><div class="col-md-6"><div class="mb-3"><label for="battery_per_kWh" class="form-label">Installed Cost ($/kWh)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="battery_per_kWh" data-pysam-key="battery_per_kWh" data-pysam-module="Cashloan" step="0.01" min="0" value="470"></div><div class="form-text text-muted small">cost per kwh of storage capacity</div></div></div><div class="col-md-6"><div class="mb-3"><label for="om_batt_variable_cost" class="form-label">OM Costs per MWh ($MWh)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="om_batt_variable_cost" data-pysam-key="om_batt_variable_cost" data-pysam-module="Pvsamv1" step="0.01" min="0" value="20"></div><div class="form-text text-muted small">Operational cost by volume</div></div></div><div class="col-md-6"><div class="mb-3"><label for="om_batt_fixed_cost" class="form-label">OM Costs fixed ($/kW-year)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="om_batt_fixed_cost" data-pysam-key="om_batt_fixed_cost" data-pysam-module="Pvsamv1" step="0.01" min="0" value="10"></div><div class="form-text text-muted small">Operational cost by capacity</div></div></div><div class="col-md-6"><div class="mb-3"><label for="bos_battery_costs" class="form-label">Balance of system equipment</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="bos_battery_costs" data-pysam-key="bos_battery_costs" data-pysam-module="Pvsamv1" step="0.01" min="0" value="666"></div><div class="form-text text-muted small">Balance of system (Batt) costs</div></div></div><div class="col-md-6"><div class="mb-3"><label for="om_batt_replacement_cost" class="form-label">Battery Replacement Cost ($/kWh)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="om_batt_replacement_cost" data-pysam-key="om_batt_replacement_cost" data-pysam-module="Pvsamv1" step="0.01" min="0" value="1800"></div><div class="form-text text-muted small">Cost per kWh for replacing battery</div></div></div><div class="col-md-6"><div class="mb-3"><label for="om_fixed" class="form-label">O&amp;M Cost Fixed ($year)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="om_fixed" data-pysam-key="om_fixed" data-pysam-module="Cashloan" step="0.01" min="0" value="50"></div><div class="form-text text-muted small">O&amp;M Costs Fixed</div></div></div></div><div class="subsection-header"><h4><i class="fas fa-layer-group me-2"></i>Project ($)</h4></div><div class="row"><div class="col-md-6"><div class="mb-3"><label for="insurance_rate" class="form-label">Insurance Rate (%)</label><div class="input-group"><input type="number" class="form-control" id="insurance_rate" data-pysam-key="insurance_rate" data-pysam-module="Cashloan" step="0.1" min="0" max="100" value="1"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Insurance rate applied on total cost</div></div></div><div class="col-md-6"><div class="mb-3"><label for="om_land_lease" class="form-label">Land lease cost [$/acre]</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="om_land_lease" data-pysam-key="om_land_lease" data-pysam-module="Pvsamv1" step="0.01" min="0" value=""></div><div class="form-text text-muted small">Land leasing costs per year</div></div></div><div class="col-md-6"><div class="mb-3"><label for="permitting_costs" class="form-label">Permitting and environmental studies $</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="permitting_costs" data-pysam-key="permitting_costs" data-pysam-module="Pvsamv1" step="0.01" min="0" value="10000"></div><div class="form-text text-muted small">Project cost grouping - Permitting</div></div></div><div class="col-md-6"><div class="mb-3"><label for="engineering_costs" class="form-label">Engineering and developer overhead $</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="engineering_costs" data-pysam-key="engineering_costs" data-pysam-module="Pvsamv1" step="0.01" min="0" value="200000"></div><div class="form-text text-muted small">Project cost grouping - Engineering</div></div></div><div class="col-md-6"><div class="mb-3"><label for="grid_interconnection_costs" class="form-label">Grid interconnection ($)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="grid_interconnection_costs" data-pysam-key="grid_interconnection_costs" data-pysam-module="Pvsamv1" step="0.01" min="0" value="1002"></div><div class="form-text text-muted small">Project cost grouping - Grid Connection</div></div></div><div class="col-md-6"><div class="mb-3"><label for="metering_costs" class="form-label">Metering and CTs installation ($)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="metering_costs" data-pysam-key="metering_costs" data-pysam-module="Pvsamv1" step="0.01" min="0" value="1003"></div><div class="form-text text-muted small">Project cost groupings - Metering</div></div></div><div class="col-md-6"><div class="mb-3"><label for="overhead_costs" class="form-label">Overhead Costs ($)</label><div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="overhead_costs" data-pysam-key="overhead_costs" data-pysam-module="Pvsamv1" step="0.01" min="0" value="1005"></div><div class="form-text text-muted small">Fixed costs for admin &amp; oversight</div></div></div><div class="col-md-6"><div class="mb-3"><label for="installer_margin" class="form-label">Installer margin (%)</label><div class="input-group"><input type="number" class="form-control" id="installer_margin" data-pysam-key="installer_margin" data-pysam-module="Pvsamv1" step="0.1" min="0" max="100" value="5"><span class="input-group-text">%</span></div><div class="form-text text-muted small">Margin applied to overall project</div></div></div></div></div></div><div class="tab-pane fade" id="load"><div class="form-card p-4"><h3 class="mb-4"><i class="fas fa-chart-line me-2 text-primary"></i>Load</h3>
        <!-- Grid Connection Configuration Section -->
        <div class="subsection-header">
            <h4><i class="fas fa-plug me-2"></i>Grid Connection Configuration</h4>
        </div>
        <div class="rate-input-group mb-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="enable_interconnection_limit" class="form-label fw-semibold">
                        Enable Grid Interconnection Limit?
                    </label>
                    <select class="form-control" id="enable_interconnection_limit" name="enable_interconnection_limit" data-pysam-key="grid.enable_interconnection_limit" value="yes">
                        <option value="yes" selected="selected">Yes</option>
                        <option value="no">No</option>
                    </select>
                    <div class="form-text">Controls whether to enforce AC power limits to/from grid</div>
                </div>
                <div class="col-md-6">
                    <label for="grid_interconnection_limit_kwac" class="form-label fw-semibold">
                        Grid Interconnection Limit (kW AC)
                    </label>
                    <input type="number" class="form-control" id="grid_interconnection_limit_kwac" name="grid_interconnection_limit_kwac" data-pysam-key="grid.grid_interconnection_limit_kwac" value="" min="0" step="0.1" placeholder="Optional">
                    <div class="form-text">Maximum AC power allowed to/from grid</div>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <label for="load_escalation" class="form-label fw-semibold">
                        Load Escalation (%)
                        <span class="text-danger">*</span>
                    </label>
                    <input type="number" class="form-control" id="load_escalation" name="load_escalation" data-pysam-key="grid.load_escalation" value="2" min="-10" max="20" step="0.1" required="">
                    <div class="form-text">Annual load growth rate (%/year)</div>
                </div>
                <div class="col-md-4">
                    <label for="load_step" class="form-label fw-semibold">
                        Data Resolution
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-control" id="load_step" name="load_step" data-pysam-key="grid.load_step" required="" value="1">
                        <option value="1" selected="selected">Hourly (8760 points)</option>
                        <option value="24">Daily (365 points)</option>
                    </select>
                    <div class="form-text">Time resolution for load data analysis</div>
                </div>
                <div class="col-md-4">
                    <label for="load_peak" class="form-label fw-semibold">
                        Peak Demand (kW)
                    </label>
                    <input type="number" class="form-control" id="load_peak" name="load_peak" data-pysam-key="grid.load_peak" value="" min="0" step="0.1" placeholder="Auto-calculated from profile">
                    <div class="form-text">Maximum load in profile (auto-calculated if empty)</div>
                </div>
            </div>
        </div>

        <!-- Annual Energy Fallback -->
        <div class="subsection-header">
            <h4><i class="fas fa-battery-three-quarters me-2"></i>Load Data Configuration</h4>
        </div>
        <div class="rate-input-group mb-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="annual_energy" class="form-label fw-semibold">
                        Annual AC Energy in Year 1 (kWh)
                    </label>
                    <input type="number" class="form-control" id="annual_energy" name="annual_energy" data-pysam-key="grid.annual_energy" value="726208" min="0" step="1">
                    <div class="form-text">Used only if no detailed load profile is provided</div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Load Data Priority:</strong><br>
                        1. Custom CSV upload (preferred)<br>
                        2. Auto-generated profile<br>
                        3. Annual energy fallback
                    </div>
                </div>
            </div>
        </div>

        <div class="load-section" id="load-config-container">
            <div class="subsection-header">
                <h4><i class="fas fa-chart-line me-2"></i>Load Profile Configuration</h4>
            </div>

            <!-- Load Method Selection -->
            <div class="mb-4">
                <h5 class="mb-3"><i class="fas fa-cog me-2"></i>Load Data Method</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="load-method-card selected" data-method="auto" onclick="selectLoadMethod('auto')">
                            <div class="text-center">
                                <div class="method-icon text-primary">
                                    <i class="fas fa-magic"></i>
                                </div>
                                <h6 class="fw-semibold">Auto-Generate</h6>
                                <p class="text-muted small mb-0">Generate typical load profile from annual energy</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="load-method-card" data-method="manual" onclick="selectLoadMethod('manual')">
                            <div class="text-center">
                                <div class="method-icon text-warning">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <h6 class="fw-semibold">Manual Entry</h6>
                                <p class="text-muted small mb-0">Enter monthly energy consumption</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="load-method-card" data-method="file" onclick="selectLoadMethod('file')">
                            <div class="text-center">
                                <div class="method-icon text-success">
                                    <i class="fas fa-upload"></i>
                                </div>
                                <h6 class="fw-semibold">Upload CSV</h6>
                                <p class="text-muted small mb-0">Upload 8760-hour load data</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Load Configuration Content -->
            <div id="load-config-content">
        <div class="rate-input-group">
            <h5 class="mb-3"><i class="fas fa-magic me-2"></i>Auto-Generation Settings</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="load-annual-energy" class="form-label fw-semibold">
                        Annual Energy Consumption (kWh)
                    </label>
                    <input type="number" id="load-annual-energy" class="form-control" value="30000" min="0" step="100" onchange="updateAutoGeneration()">
                    <div class="form-text">Typical residential: 8,000-15,000 kWh/year</div>
                </div>
                <div class="col-md-6">
                    <label for="load-type-select" class="form-label fw-semibold">Load Type</label>
                    <select id="load-type-select" class="form-control" onchange="updateAutoGeneration()" value="commercial">
                        <option value="residential">Residential</option>
                        <option value="commercial" selected="selected">Commercial</option>
                        <option value="industrial">Industrial</option>
                    </select>
                    <div class="form-text">Determines hourly usage patterns</div>
                </div>
                <div class="col-12">
                    <button type="button" class="btn btn-primary" onclick="generateAutoLoad()">
                        <i class="fas fa-chart-line me-2"></i>Generate Load Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

            <!-- Load Validation Results -->
            <div id="load-validation-display" style="display: block;">
        <div class="load-validation-result success">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2"></i>
                <div class="flex-grow-1">
                    <strong>Validation Passed</strong>
                    <div class="mt-1">Load profile generated successfully</div>
                </div>
            </div>
        </div>
    </div>

            <!-- Load Chart Display -->
            <div id="load-chart-display" style="display: block;">
                <h5 class="mb-3"><i class="fas fa-chart-area me-2"></i>Load Profile Preview</h5>
                <div class="load-chart-container" id="load-chart-container"><canvas id="load-chart-canvas" style="display: block; box-sizing: border-box; height: 266px; width: 1164px;" width="1164" height="266"></canvas></div>
            </div>

            <!-- Hidden fields for PySAM integration -->
            <input type="hidden" id="hidden_load_method" data-pysam-key="load_method" value="auto">
            <input type="hidden" id="hidden_load_data" data-pysam-key="load_data" value="">
            <input type="hidden" id="hidden_load_annual_energy" data-pysam-key="load_annual_energy" value="30000">
            <input type="hidden" id="hidden_load_type" data-pysam-key="load_type" value="commercial">

            <!-- PySAM Grid Configuration Hidden Fields -->
            <input type="hidden" id="hidden_enable_interconnection_limit" data-pysam-key="grid.enable_interconnection_limit" value="yes">
            <input type="hidden" id="hidden_grid_interconnection_limit_kwac" data-pysam-key="grid.grid_interconnection_limit_kwac" value="">
            <input type="hidden" id="hidden_load_escalation" data-pysam-key="grid.load_escalation" value="2">
            <input type="hidden" id="hidden_load_step" data-pysam-key="grid.load_step" value="1">
            <input type="hidden" id="hidden_load_peak" data-pysam-key="grid.load_peak" value="">
            <input type="hidden" id="hidden_annual_energy" data-pysam-key="grid.annual_energy" value="726208">
        </div>
    </div></div></div></div>

            <!-- Form Actions with FCAS Revenue Display and Dashboard Integration -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center p-4 bg-white rounded-3 shadow-sm">
                        <!-- SIMPLIFIED Form Status - NO PERCENTAGES -->
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-tasks text-primary me-2"></i>
                                <span class="text-muted small">Form Status</span>
                            </div>
                            <span class="text-muted small">Ready</span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            
                            <button type="button" class="btn btn-outline-secondary" id="save-draft-btn">
                                <i class="fas fa-save me-2"></i>
                                Save Draft
                            </button>

                            <button type="button" class="btn btn-outline-primary" id="validate-form-btn">
                                <i class="fas fa-check-circle me-2"></i>
                                Validate
                            </button>

                            <div class="dropdown">
                                <button class="btn btn-outline-info dropdown-toggle" type="button" id="previewDropdown" data-bs-toggle="dropdown">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="preview-config">
                                        <i class="fas fa-cog me-2"></i>Configuration Summary
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="preview-fcas">
                                        <i class="fas fa-bolt me-2"></i>FCAS Settings
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="preview-tariff">
                                        <i class="fas fa-plug me-2"></i>Tariff Settings
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" id="preview-load">
                                        <i class="fas fa-chart-line me-2"></i>Load Profile
                                    </a></li>
                                </ul>
                            </div>
                            

                            <button type="submit" class="btn btn-primary px-4" id="run-analysis-btn" disabled=""><i class="fas fa-spinner fa-spin me-2"></i>Processing...</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- Analysis Success Notification with Dashboard Link -->
        <div class="success-with-dashboard" id="analysis-success-banner" style="display: none;">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-2">
                        <i class="fas fa-check-circle me-2"></i>
                        Analysis Completed Successfully!
                    </h5>
                    <p class="mb-0">
                        Your energy system analysis has been completed with enhanced FCAS revenue forecasting.
                        <span id="success-fcas-summary"></span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/dashboard/" class="btn btn-light btn-lg">
                        <i class="fas fa-chart-line me-2"></i>
                        View Results Dashboard
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Configuration Preview Modal -->
    <div class="modal fade" id="configPreviewModal" tabindex="-1" aria-labelledby="configPreviewTitle" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configPreviewTitle">
                        <i class="fas fa-eye me-2"></i>
                        Configuration Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="configPreviewContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="exportConfiguration()">
                        <i class="fas fa-download me-2"></i>Export Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Data Upload Modal -->
    <div class="modal fade" id="loadUploadModal" tabindex="-1" aria-labelledby="loadUploadTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loadUploadTitle">
                        <i class="fas fa-upload me-2"></i>Upload Load Data
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="load-upload-content">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="confirm-load-upload" disabled="">
                        <i class="fas fa-check me-2"></i>Use This Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <!-- Notifications will be inserted here -->
    </div>

    <!-- Footer -->
    <footer class="bg-white border-top py-4 mt-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-leaf text-success me-2"></i>
                        <span class="text-muted">Powered by EnTrans Energy Solutions</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="text-end text-muted small">
                        <span class="me-3">
                            <i class="fas fa-brain me-1"></i>
                            ML-Enhanced FCAS Forecasting
                        </span>
                        <span class="me-3">
                            <i class="fas fa-lock me-1"></i>
                            Secure &amp; Confidential
                        </span>
                        <span>
                            <i class="fas fa-clock me-1"></i>
                            Session: <span id="session-timer">01:26</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Chart.js for load visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Enhanced Form Script with FCAS Integration -->
    <script src="/static/js/tariff_v4.js"></script>

    <!-- PRODUCTION-READY: Core Application JavaScript -->
    <script>
        // Global configuration and state management
        const restoredValues = {};
        const isRestoration = false;

        // Application state
        let autoPollingInterval;
        let isAutoPolling = false;
        let sessionStart = Date.now();
        let submissionTimeout;

        // DOM element cache for performance
        const domCache = {
            form: null,
            submitBtn: null,
            progressDiv: null,

            init() {
                this.form = document.getElementById('analysis-form');
                this.submitBtn = document.getElementById('run-analysis-btn');
                this.progressDiv = document.getElementById('analysis-progress');
            }
        };

        // ========== PRODUCTION: FORM DATA PERSISTENCE (PRESERVED) ==========
        function persistFormValuesToHTML() {
            const form = domCache.form || document.getElementById('analysis-form');
            if (!form) {
                console.error('Form not found for persistence');
                return false;
            }

            try {
                let persistedCount = 0;
                const allElements = form.querySelectorAll('input, select, textarea');

                allElements.forEach(element => {
                    try {
                        const elementType = element.type || element.tagName.toLowerCase();

                        if (elementType === 'checkbox') {
                            if (element.checked) {
                                element.setAttribute('checked', 'checked');
                            } else {
                                element.removeAttribute('checked');
                            }
                            persistedCount++;

                        } else if (elementType === 'radio') {
                            if (element.checked) {
                                element.setAttribute('checked', 'checked');
                            } else {
                                element.removeAttribute('checked');
                            }
                            persistedCount++;

                        } else if (element.tagName.toLowerCase() === 'select') {
                            const currentValue = element.value;
                            element.setAttribute('value', currentValue);

                            Array.from(element.options).forEach(option => {
                                if (option.value === currentValue) {
                                    option.setAttribute('selected', 'selected');
                                } else {
                                    option.removeAttribute('selected');
                                }
                            });
                            persistedCount++;

                        } else {
                            const currentValue = element.value;
                            element.setAttribute('value', currentValue);
                            persistedCount++;
                        }

                    } catch (error) {
                        // Continue processing other elements
                    }
                });

                return persistedCount > 0;
            } catch (error) {
                console.error('Form persistence failed:', error.message);
                return false;
            }
        }

        // ========== PRODUCTION: FORM DATA COLLECTION (PRESERVED) ==========
        function collectFormData() {
            const formData = {};
            const form = domCache.form || document.getElementById('analysis-form');

            if (!form) {
                console.error('Form not found for data collection');
                return formData;
            }

            try {
                // Method 1: Get all form elements with names
                const namedElements = form.querySelectorAll('[name]');
                namedElements.forEach(element => {
                    const name = element.getAttribute('name');
                    if (name) {
                        if (element.type === 'checkbox') {
                            formData[name] = element.checked;
                        } else if (element.type === 'radio') {
                            if (element.checked) {
                                formData[name] = element.value;
                            }
                        } else {
                            formData[name] = element.value;
                        }
                    }
                });

                // Method 2: Get all elements with data-pysam-key attributes
                const pysamElements = form.querySelectorAll('[data-pysam-key]');
                pysamElements.forEach(element => {
                    const key = element.getAttribute('data-pysam-key');
                    if (key) {
                        if (element.type === 'checkbox') {
                            formData[key] = element.checked;
                        } else if (element.type === 'radio') {
                            if (element.checked) {
                                formData[key] = element.value;
                            }
                        } else {
                            formData[key] = element.value;
                        }
                    }
                });

                // Method 3: Get all input, select, textarea elements by ID
                const allInputs = form.querySelectorAll('input, select, textarea');
                allInputs.forEach(element => {
                    if (element.id) {
                        if (element.type === 'checkbox') {
                            formData[element.id] = element.checked;
                        } else if (element.type === 'radio') {
                            if (element.checked) {
                                formData[element.id] = element.value;
                            }
                        } else if (element.value !== '') {
                            formData[element.id] = element.value;
                        }
                    }
                });

                // Method 4: Collect load configuration data
                if (window.loadDataManager && window.loadDataManager.getFormData) {
                    const loadData = window.loadDataManager.getFormData();
                    Object.assign(formData, loadData);
                }

                return formData;
            } catch (error) {
                console.error('Form data collection failed:', error.message);
                return {};
            }
        }

        // ========== PRODUCTION: ENHANCED FORM SUBMISSION WITH CACHE CLEARING ==========
        function handleFormSubmission(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('run-analysis-btn');
            if (!submitBtn || submitBtn.disabled) return false;

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            try {
                // Persist form values
                const persistSuccess = persistFormValuesToHTML();
                if (!persistSuccess) {
                    throw new Error('Failed to persist form values');
                }

                // Collect and submit form data
                const formData = collectFormData();
                const submitData = {
                    form_html: document.documentElement.outerHTML,
                    form_data: formData
                };

                fetch('/run-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submitData)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'started') {
                        showNotification('Analysis started successfully', 'success');
                        setTimeout(() => startAutoPolling(), 2000);
                    } else {
                        throw new Error(result.error || 'Analysis failed to start');
                    }
                })
                .catch(error => {
                    showNotification('Unable to submit analysis. Please try again.', 'error');
                    resetSubmitButton();
                });

            } catch (error) {
                showNotification('Submission failed. Please try again.', 'error');
                resetSubmitButton();
            }
        }

        // Update the autoPollingFunction to use cache-busted requests
        function autoPollingFunction() {
            fetch('/analysis-status')
                .then(r => {
                    if (!r.ok) throw new Error(`Status check failed: ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    updateSimpleStatus(data);

                    if (!data.running || data.stage === 'completed') {
                        stopAutoPolling();
                        showCompletionUI(data);
                    } else if (data.stage === 'failed') {
                        stopAutoPolling();
                        showFailureUI(data);
                    }
                })
                .catch(err => {
                    // Continue polling on network errors
                });
        }

        // ========== PRODUCTION: UTILITY FUNCTIONS ==========
        function resetSubmitButton() {
            const submitBtn = domCache.submitBtn || document.getElementById('run-analysis-btn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i>Run Analysis';
            }
        }

        function validateEnvironment() {
            if (typeof fetch === 'undefined') {
                console.error('Fetch API not supported');
                showNotification('Your browser is not supported. Please update or use a modern browser.', 'error');
                return false;
            }
            return true;
        }

        // ========== PRODUCTION: SIMPLIFIED PROGRESS TRACKING ==========
        function startAutoPolling() {
            if (isAutoPolling) return;

            isAutoPolling = true;
            let pollCount = 0;
            const maxPolls = 200; // 10 minutes at 3-second intervals

            const progressDiv = domCache.progressDiv || document.getElementById('analysis-progress');
            if (progressDiv) progressDiv.classList.add('show');

            autoPollingInterval = setInterval(() => {
                pollCount++;

                if (pollCount > maxPolls) {
                    console.error('Analysis polling timeout');
                    stopAutoPolling();
                    showNotification('Analysis is taking longer than expected. Please check the dashboard.', 'warning');
                    return;
                }

                autoPollingFunction();
            }, 3000);

            autoPollingFunction();
        }

        function updateSimpleStatus(data) {
            const progressMsg = document.getElementById('progress-message');
            const progressTitle = document.getElementById('progress-title');

            if (progressMsg) {
                progressMsg.textContent = data.message || 'Processing...';
            }

            if (progressTitle) {
                const titles = {
                    'initializing': 'Starting...',
                    'form_integration': 'Processing...',
                    'pysam_simulation': 'Running Simulation...',
                    'results_compilation': 'Finalizing...',
                    'completed': 'Complete!',
                    'failed': 'Failed'
                };
                progressTitle.textContent = titles[data.stage] || 'Processing...';
            }
        }

        function stopAutoPolling() {
            isAutoPolling = false;
            if (autoPollingInterval) {
                clearInterval(autoPollingInterval);
                autoPollingInterval = null;
            }
        }

        function showCompletionUI(data) {
            const progressDiv = domCache.progressDiv || document.getElementById('analysis-progress');
            if (progressDiv) progressDiv.classList.remove('show');

            const successBanner = document.getElementById('analysis-success-banner');
            if (successBanner) successBanner.style.display = 'block';

            showNotification('Analysis completed! Redirecting to dashboard...', 'success');

            setTimeout(() => {
                window.location.href = '/dashboard/';
            }, 3000);
        }

        function showFailureUI(data) {
            const progressDiv = domCache.progressDiv || document.getElementById('analysis-progress');
            if (progressDiv) progressDiv.classList.remove('show');

            const errorMessage = data.error || 'Analysis failed. Please try again.';
            showNotification(`Analysis failed: ${errorMessage}`, 'error');
            resetSubmitButton();
        }

        function checkForRunningAnalysis() {
            fetch('/analysis-status')
                .then(r => r.json())
                .then(data => {
                    if (data.running) {
                        startAutoPolling();
                    }
                })
                .catch(() => {
                    // No analysis running
                });
        }

        // ========== PRODUCTION: INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            if (!validateEnvironment()) return;

            // Initialize DOM cache
            domCache.init();

            // Initialize form restoration if needed
            if (isRestoration && Object.keys(restoredValues).length > 0) {
                setTimeout(() => {
                    restoreFormValues(restoredValues);
                }, 1000);
            }

            // Initialize event listeners and functionality
            initializeEventListeners();
            initializeSessionTimer();

            // Hide loading state and initialize components
            setTimeout(() => {
                const loading = document.getElementById('form-loading');
                if (loading) loading.style.display = 'none';
                updateDashboardLink();
                initializeFCAS();
            }, 500);

            // Check for running analysis on page load
            setTimeout(checkForRunningAnalysis, 1000);
        });

        // ========== PRODUCTION: EVENT LISTENERS ==========
        function initializeEventListeners() {
            const form = domCache.form || document.getElementById('analysis-form');
            if (form) {
                form.addEventListener('submit', handleFormSubmission);
            }

            // Configuration preview handlers
            const previewHandlers = [
                { id: 'preview-config', type: 'full' },
                { id: 'preview-fcas', type: 'fcas' },
                { id: 'preview-tariff', type: 'tariff' },
                { id: 'preview-load', type: 'load' }
            ];

            previewHandlers.forEach(handler => {
                const element = document.getElementById(handler.id);
                if (element) {
                    element.addEventListener('click', function(e) {
                        e.preventDefault();
                        showConfigurationPreview(handler.type);
                    });
                }
            });

            // Form validation handler
            const validateBtn = document.getElementById('validate-form-btn');
            if (validateBtn) {
                validateBtn.addEventListener('click', validateForm);
            }

            // Save draft handler (only for new forms)
            if (!isRestoration) {
                const saveDraftBtn = document.getElementById('save-draft-btn');
                if (saveDraftBtn) {
                    saveDraftBtn.addEventListener('click', saveDraft);
                }
                loadSavedDraft();
            }
        }

        // ========== PRODUCTION: SIMPLIFIED FORM PROGRESS ==========
        function updateFormProgress() {
            // Simplified - no calculations needed for production
        }

        // ========== PRODUCTION: FCAS INTEGRATION (PRESERVED) ==========
        function updateFCASIndicators() {
            const fcasEnabled = document.getElementById('fcas-enable')?.checked || false;
            const headerStatus = document.getElementById('header-fcas-status');

            if (headerStatus) {
                if (fcasEnabled) {
                    headerStatus.className = 'fcas-status enabled';
                    headerStatus.innerHTML = '<i class="fas fa-bolt me-1"></i><span>FCAS Active</span>';
                } else {
                    headerStatus.className = 'fcas-status disabled';
                    headerStatus.innerHTML = '<i class="fas fa-bolt me-1"></i><span>FCAS Disabled</span>';
                }
            }
        }

        function initializeFCAS() {
            const fcasEnableCheckbox = document.getElementById('fcas-enable');
            if (fcasEnableCheckbox) {
                fcasEnableCheckbox.addEventListener('change', function(e) {
                    updateFCASIndicators();
                });
            }
            updateFCASIndicators();
        }

        // ========== PRODUCTION: FORM RESTORATION (PRESERVED) ==========
        function restoreFormValues(values) {
            Object.entries(values).forEach(([key, value]) => {
                const element = document.getElementById(key) || document.querySelector(`[name="${key}"]`);

                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value === true || value === 'true' || value === 'on';
                    } else if (element.type === 'radio') {
                        if (element.value === value) {
                            element.checked = true;
                        }
                    } else if (element.tagName === 'SELECT') {
                        const option = element.querySelector(`option[value="${value}"]`);
                        if (option) {
                            element.value = value;
                        }
                    } else {
                        element.value = value;
                    }

                    element.dispatchEvent(new Event('change', { bubbles: true }));
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });

            // Special handling for FCAS configuration
            if (values['fcas-enable'] || values['fcas_enable']) {
                setTimeout(() => {
                    if (typeof updateFCASIndicators === 'function') {
                        updateFCASIndicators();
                    }
                }, 500);
            }
        }

        // ========== PRODUCTION: CONFIGURATION PREVIEW ==========
        function showConfigurationPreview(type) {
            const modal = new bootstrap.Modal(document.getElementById('configPreviewModal'));
            const content = document.getElementById('configPreviewContent');
            const title = document.getElementById('configPreviewTitle');

            let previewHTML = '';

            switch(type) {
                case 'fcas':
                    title.innerHTML = '<i class="fas fa-bolt me-2"></i>FCAS Configuration Preview';
                    previewHTML = generateFCASPreview();
                    break;
                case 'tariff':
                    title.innerHTML = '<i class="fas fa-plug me-2"></i>Tariff Configuration Preview';
                    previewHTML = generateTariffPreview();
                    break;
                case 'load':
                    title.innerHTML = '<i class="fas fa-chart-line me-2"></i>Load Profile Preview';
                    previewHTML = generateLoadPreview();
                    break;
                default:
                    title.innerHTML = '<i class="fas fa-eye me-2"></i>Full Configuration Preview';
                    previewHTML = generateFullPreview();
            }

            content.innerHTML = previewHTML;
            modal.show();
        }

        function generateFCASPreview() {
            const fcasEnabled = document.getElementById('fcas-enable')?.checked || false;

            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6>FCAS Configuration</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Status:</strong></td><td>${fcasEnabled ? 'Enabled' : 'Disabled'}</td></tr>
                            <tr><td><strong>Note:</strong></td><td>Configure FCAS settings in Financial Parameters tab</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            FCAS configuration is handled in the Financial Parameters section of the form.
                        </div>
                    </div>
                </div>
            `;
        }

        function generateTariffPreview() {
            const tariffType = document.getElementById('tariff-type-select')?.value || 'Flat';
            const fixedCharge = document.getElementById('monthly-fixed-charge')?.value || '10.00';
            const feedInTariff = document.getElementById('feed-in-tariff')?.value || '0.05';

            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Tariff Configuration</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Tariff Type:</strong></td><td>${tariffType}</td></tr>
                            <tr><td><strong>Monthly Fixed Charge:</strong></td><td>${fixedCharge}</td></tr>
                            <tr><td><strong>Feed-in Tariff:</strong></td><td>${feedInTariff}/kWh</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Rate Details</h6>
                        ${tariffType === 'Flat' ?
                            `<p>Flat Rate: ${document.getElementById('flat-rate')?.value || '0.12'}/kWh</p>` :
                            '<p>Time-of-Use rates configured</p>'
                        }
                    </div>
                </div>
            `;
        }

        function generateLoadPreview() {
            const loadMethod = window.loadDataManager?.getCurrentMethod() || 'auto';
            const loadSummary = window.loadDataManager?.getSummary() || 'No load data configured';

            return `
                <div class="row">
                    <div class="col-md-12">
                        <h6>Load Configuration</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Method:</strong></td><td>${loadMethod}</td></tr>
                            <tr><td><strong>Summary:</strong></td><td>${loadSummary}</td></tr>
                        </table>
                        ${window.loadDataManager?.hasChart() ?
                            '<div class="mt-3"><canvas id="preview-load-chart" width="400" height="200"></canvas></div>' :
                            '<div class="alert alert-info mt-3">No load chart available</div>'
                        }
                    </div>
                </div>
            `;
        }

        function generateFullPreview() {
            return `
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Full configuration preview includes form data, FCAS settings, tariff configuration, and load profile.
                            <hr>
                            <div class="row">
                                <div class="col-md-4">
                                    ${generateFCASPreview()}
                                </div>
                                <div class="col-md-4">
                                    ${generateTariffPreview()}
                                </div>
                                <div class="col-md-4">
                                    ${generateLoadPreview()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function exportConfiguration() {
            showNotification('Export functionality ready - configuration will be downloaded.', 'info');
        }

        // ========== PRODUCTION: FORM VALIDATION & DRAFT MANAGEMENT ==========
        function validateForm() {
            const form = domCache.form || document.getElementById('analysis-form');

            if (form.checkValidity()) {
                showNotification('Form validation passed! All required fields are completed.', 'success');
            } else {
                form.classList.add('was-validated');
                showNotification('Please complete all required fields before proceeding.', 'warning');

                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function saveDraft() {
            try {
                const formData = new FormData(domCache.form || document.getElementById('analysis-form'));
                const draftData = Object.fromEntries(formData);

                localStorage.setItem('entrans_form_draft', JSON.stringify(draftData));
                showNotification('Draft saved successfully!', 'success');
            } catch (error) {
                showNotification('Failed to save draft', 'error');
            }
        }

        function loadSavedDraft() {
            try {
                const savedDraft = localStorage.getItem('entrans_form_draft');
                if (savedDraft) {
                    const draftData = JSON.parse(savedDraft);
                    showNotification('Previous draft found. Would you like to restore it?', 'info', true);
                }
            } catch (error) {
                // Ignore invalid draft data
            }
        }

        // ========== PRODUCTION: UTILITY FUNCTIONS ==========
        function updateDashboardLink() {
            const dashboardLink = document.getElementById('dashboard-link');
            if (dashboardLink) {
                dashboardLink.classList.remove('disabled');
            }
        }

        function initializeSessionTimer() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timer = document.getElementById('session-timer');
                if (timer) {
                    timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function showNotification(message, type = 'info', persistent = false) {
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'position-fixed top-0 end-0 p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }

            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
            notification.style.cssText = 'min-width: 300px; margin-bottom: 0.5rem;';

            const icon = {
                'success': 'fas fa-check-circle',
                'warning': 'fas fa-exclamation-triangle',
                'error': 'fas fa-times-circle',
                'info': 'fas fa-info-circle'
            }[type] || 'fas fa-info-circle';

            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="${icon} me-2"></i>
                    <div class="flex-grow-1">${message}</div>
                    ${!persistent ? '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' : ''}
                </div>
            `;

            container.appendChild(notification);

            if (!persistent) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
        }

        // ========== PRODUCTION: GLOBAL FUNCTION EXPORTS ==========
        // Essential functions for external scripts
        window.updateFCASIndicators = updateFCASIndicators;
        window.updateFormProgress = updateFormProgress;
        window.showNotification = showNotification;
        window.exportConfiguration = exportConfiguration;
        window.persistFormValuesToHTML = persistFormValuesToHTML;
        window.collectFormData = collectFormData;
    </script>

<div class="progress-indicator" style="transform: scaleX(0.714286);"></div></body></html>