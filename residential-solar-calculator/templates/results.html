{% extends "base.html" %}
{% block title %}Your Solar & Battery Results{% endblock %}

{% block content %}
<div class="form-container">
    <div class="progress-bar">
        <div class="step completed">1. Energy Profile</div>
        <div class="step completed">2. Electricity Tariffs</div>
        <div class="step completed">3. Solar System</div>
        <div class="step completed">4. Battery Analysis</div>
    </div>

    <h1>Your Solar & Battery Analysis Results</h1>
    <p class="subtitle">Compare scenarios and see your potential savings</p>

    <!-- System Overview -->
    <div class="results-overview">
        <div class="overview-card">
            <h3>Your Current Situation</h3>
            <div class="current-stats">
                <div class="stat-item">
                    <span class="stat-value">${{ "{:,.0f}".format(results.tariff.current_bill.total_cost) }}</span>
                    <span class="stat-label">Annual electricity bill</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ "{:,.0f}".format(results.profile.annual_usage) }}</span>
                    <span class="stat-label">kWh used per year</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ results.profile.postcode }}</span>
                    <span class="stat-label">Location</span>
                </div>
            </div>
        </div>

        <div class="overview-card">
            <h3>Recommended System</h3>
            <div class="system-stats">
                <div class="stat-item">
                    <span class="stat-value">{{ "{:.1f}".format(results.solar.system_size) }} kW</span>
                    <span class="stat-label">Solar system size</span>
                </div>
                {% if results.battery.include_battery %}
                <div class="stat-item">
                    <span class="stat-value">{{ "{:.1f}".format(results.battery.battery_size) }} kWh</span>
                    <span class="stat-label">Battery capacity</span>
                </div>
                {% endif %}
                <div class="stat-item">
                    <span class="stat-value">{{ "{:,.0f}".format(results.solar.generation_data.annual_kwh) }}</span>
                    <span class="stat-label">kWh generated per year</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scenario Comparison -->
    <div class="scenarios-section">
        <h2>Scenario Comparison</h2>

        <div class="scenario-cards">
            {% set best_scenario = results.battery.scenarios.values() | list | sort(attribute='annual_cost') | first %}
            {% for scenario_key, scenario in results.battery.scenarios.items() %}
            <div class="scenario-card {% if scenario.annual_cost == best_scenario.annual_cost and results.battery.include_battery %}recommended{% endif %}">
                <h3>{{ scenario.name }}</h3>
                <p class="scenario-desc">{{ scenario.description }}</p>

                <div class="scenario-stats">
                    <div class="main-stat">
                        <span class="cost-value">${{ "{:,.0f}".format(scenario.annual_cost) }}</span>
                        <span class="cost-label">Annual Cost</span>
                        {% set savings = results.tariff.current_bill.total_cost - scenario.annual_cost %}
                        {% if savings > 0 %}
                        <span class="savings">Save ${{ "{:,.0f}".format(savings) }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Investment Summary -->
    {% if results.battery.include_battery or results.solar.solar_status == 'planning' %}
    <div class="investment-section">
        <h2>Investment Summary</h2>
        <div class="investment-card">
            <div class="investment-costs">
                {% if results.solar.solar_status == 'planning' %}
                <div class="cost-item">
                    <span>Solar Installation:</span>
                    <span>${{ "{:,.0f}".format(results.solar.installation_cost) }}</span>
                </div>
                {% endif %}
                {% if results.battery.include_battery %}
                <div class="cost-item">
                    <span>Battery System:</span>
                    <span>${{ "{:,.0f}".format(results.battery.battery_cost) }}</span>
                </div>
                {% endif %}
                <div class="cost-item total">
                    <span>Total Investment:</span>
                    {% set total_cost = (results.solar.installation_cost if results.solar.solar_status == 'planning' else 0) + (results.battery.battery_cost if results.battery.include_battery else 0) %}
                    <span>${{ "{:,.0f}".format(total_cost) }}</span>
                </div>
            </div>

            <div class="investment-returns">
                {% set best_scenario = results.battery.scenarios.values() | list | sort(attribute='annual_cost') | first %}
                {% set annual_savings = results.tariff.current_bill.total_cost - best_scenario.annual_cost %}
                <div class="return-item">
                    <span>Annual Savings:</span>
                    <span class="highlight">${{ "{:,.0f}".format(annual_savings) }}</span>
                </div>
                {% if total_cost > 0 %}
                <div class="return-item">
                    <span>Payback Period:</span>
                    <span>{{ "{:.1f}".format(total_cost / annual_savings if annual_savings > 0 else 99) }} years</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recommendations -->
    <div class="recommendations-section">
        <h2>Our Recommendations</h2>
        <div class="rec-cards">
            {% set best_strategy = results.battery.scenarios.values() | list | sort(attribute='annual_cost') | first %}
            <div class="rec-card primary">
                <h4>Best Strategy: {{ best_strategy.name }}</h4>
                <p>{{ best_strategy.description }}</p>
                <div class="rec-benefit">
                    Save ${{ "{:,.0f}".format(results.tariff.current_bill.total_cost - best_strategy.annual_cost) }} per year
                </div>
            </div>

            {% set solar_savings = results.tariff.current_bill.total_cost - results.battery.scenarios.solar_only.annual_cost %}
            <div class="rec-card">
                <h4>Solar Investment</h4>
                <p>Your {{ "{:.1f}".format(results.solar.system_size) }}kW solar system will save ${{ "{:,.0f}".format(solar_savings) }} annually</p>
            </div>

            {% if results.solar.system_size > 0 %}
            <div class="rec-card">
                <h4>System Performance</h4>
                <p>Generating {{ "{:.0f}".format((results.solar.generation_data.annual_kwh / results.profile.annual_usage) * 100) }}% of your usage</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-section">
        <h2>Next Steps</h2>
        <div class="action-buttons">
            <button onclick="window.print()" class="btn btn-secondary">
                Print Results
            </button>
            <button onclick="window.location.href='/step1'" class="btn btn-primary">
                Start New Analysis
            </button>
        </div>
    </div>
</div>

<style>
.results-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.overview-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.current-stats,
.system-stats {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-value {
    display: block;
    font-size: 1.8rem;
    font-weight: 700;
    color: #2c3e50;
}

.stat-label {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.scenario-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 25px;
    margin-top: 25px;
}

.scenario-card {
    background: white;
    border: 2px solid #ecf0f1;
    border-radius: 12px;
    padding: 25px;
    position: relative;
}

.scenario-card.recommended {
    border-color: #27ae60;
    box-shadow: 0 5px 20px rgba(39, 174, 96, 0.15);
}

.scenario-card.recommended::before {
    content: "RECOMMENDED";
    position: absolute;
    top: -10px;
    right: 20px;
    background: #27ae60;
    color: white;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
}

.cost-value {
    font-size: 2rem;
    font-weight: 700;
    color: #2c3e50;
}

.savings {
    color: #27ae60;
    font-weight: 600;
    font-size: 1.1rem;
}

.investment-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
}

.cost-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #ecf0f1;
}

.cost-item.total {
    border-top: 2px solid #3498db;
    border-bottom: none;
    font-weight: 700;
    font-size: 1.1rem;
    color: #2c3e50;
}

.return-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
}

.highlight {
    color: #27ae60;
    font-weight: 700;
}

.rec-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

.rec-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 20px;
}

.rec-card.primary {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border: none;
}

.rec-benefit {
    font-size: 1.2rem;
    font-weight: 600;
    margin-top: 10px;
}

.action-buttons {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin-top: 30px;
}

@media print {
    .action-buttons {
        display: none;
    }
}
</style>

{% endblock %}